# INKREALM.CO: ข้อกำหนดระบบและคุณสมบัติหลัก (V5.1)

เอกสารนี้เป็นข้อกำหนดระบบและคุณสมบัติหลักสำหรับแพลตฟอร์ม INKREALM.CO (V5.1) โดยเน้นฟังก์ชันที่จำเป็นตามการปรับปรุงล่าสุด และอ้างอิง Tech Stack (SvelteKit & Supabase Stack) ที่กำหนดไว้

##  การออกแบบโดยรวม (Overall Design Philosophy)

*   **การแสดงผลหรูหราและอ่านง่าย:** ใช้โทนสีทอง-เทา และฟอนต์ Sarabun
*   **เครื่องมือสำหรับนักแปล:** มีฟังก์ชันสนับสนุนการทำงานของนักแปลโดยเฉพาะ
*   **ใช้งานง่าย ตอบโจทย์ทุกอุปกรณ์:** UI ใช้งานง่าย (Intuitive), Responsive Design, หน้าอ่านไม่มี Horizontal Scroll

---

## 1. ภาพรวมระบบหลัก (Core System Overview)

ระบบต่างๆ ที่ประกอบกันเป็นแพลตฟอร์ม INKREALM.CO:

*   **ระบบยืนยันตัวตนและจัดการผู้ใช้:**
    *   ลงทะเบียน, เข้าสู่ระบบ (อีเมล/รหัสผ่าน, Google)
    *   ลืมรหัสผ่าน
    *   จัดการโปรไฟล์
    *   บทบาทและสิทธิ์ (ควบคุมโดย Supabase RLS)
*   **ระบบจัดการเนื้อหานิยาย (CMS):**
    *   สร้าง/แก้ไข/ลบนิยายและตอน (ผ่าน Modals เป็นหลัก)
    *   อัปโหลดเนื้อหา (ปกนิยาย, ไฟล์ .txt สำหรับตอน)
    *   การจัดการหมวดหมู่นิยาย (สำหรับ Admin)
    *   ระบบจัดการเวอร์ชันสำหรับนิยายและตอน
*   **ระบบการอ่านและบุ๊คมาร์ค:**
    *   หน้าอ่านที่ปรับแต่งได้ (ฟอนต์, ขนาด, ธีม)
    *   ระบบบุ๊คมาร์คตอน
    *   โหมดอ่านต่อเนื่อง
    *   การสลับโหมดการอ่านสำหรับนักแปล
*   **ระบบเครื่องมือสำหรับนักแปล:**
    *   โหมดแปล (เมื่อเปิดใช้งานสำหรับนิยายที่กำหนด)
    *   ระบบบรรทัดมาร์ค (Mark Lines)
    *   หน้าจัดการบรรทัดมาร์ค
*   **ระบบแดชบอร์ด:**
    *   **สำหรับนักแปล:** จัดการนิยาย, จัดการบรรทัดมาร์ค
    *   **สำหรับผู้ดูแลระบบ:** ภาพรวม, จัดการผู้ใช้, จัดการหมวดหมู่, จัดการประกาศ, จัดการเว็บไซต์, จัดการเวอร์ชัน
*   **ระบบฐานข้อมูลและไฟล์:** Supabase (PostgreSQL, Storage)
*   **ระบบการแจ้งเตือนผู้ใช้ (User Feedback System):**
    *   Toast notifications สำหรับยืนยันการกระทำต่างๆ
*   **ระบบประกาศ (Announcement System):**
    *   สำหรับ Admin ในการสร้างและเผยแพร่ประกาศไปยังผู้ใช้

---

## 2. โครงสร้าง URL ที่เป็นมิตร (User-Friendly URL Structure)

| หน้า                           | โครงสร้าง URL                                       | คำอธิบาย                                                                                                                                   |
| :----------------------------- | :--------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------- |
| หน้ารวมนิยาย (หน้าแรก)         | `/`                                                  |                                                                                                                                            |
| หน้าข้อมูลนิยาย                | `/novels/[novel_slug]`                               | `[novel_slug]` สร้างจากชื่อนิยาย (เช่น "ยอดนักปรุงยาไร้เทียมทาน" หรือ "yod-nak-prung-ya-rai-thiam-than") สามารถแก้ไขได้โดย Admin/ผู้สร้าง |
| หน้าอ่านตอนนิยาย               | `/novels/[novel_slug]/chapter/[chapter_number]`      | `[chapter_number]` คือ เลขที่ของตอน (เช่น 1, 2, 100)                                                                                       |
| หน้าโปรไฟล์ผู้ใช้              | `/profile`                                           | โปรไฟล์ของผู้ใช้ที่ล็อกอินอยู่                                                                                                              |
| หน้าบุ๊คมาร์ค                  | `/bookmarks`                                         |                                                                                                                                            |
| แดชบอร์ดนักแปล                | `/translator/dashboard`                              |                                                                                                                                            |
| หน้าจัดการบรรทัดมาร์ค (นักแปล) | `/translator/manage-marks/[novel_slug]`              |                                                                                                                                            |
| แดชบอร์ดผู้ดูแลระบบ           | `/admin/dashboard`                                   |                                                                                                                                            |
| ภาพรวม (Admin)                | `/admin/dashboard/overview`                          |                                                                                                                                            |
| จัดการผู้ใช้ (Admin)           | `/admin/dashboard/users`                             |                                                                                                                                            |
| จัดการหมวดหมู่ (Admin)        | `/admin/dashboard/categories`                        |                                                                                                                                            |
| จัดการประกาศ (Admin)          | `/admin/dashboard/announcements`                     |                                                                                                                                            |
| จัดการเว็บไซต์ (Admin)         | `/admin/dashboard/site-management`                   |                                                                                                                                            |
| จัดการเวอร์ชัน (Admin)         | `/admin/dashboard/versions`                          |                                                                                                                                            |

**การสร้าง Slug:**
*   **Novel Slug:** สร้างอัตโนมัติเมื่อสร้างนิยาย (แปลงเป็นตัวพิมพ์เล็ก, แทนที่ช่องว่างด้วย `-`, ตัดอักขระพิเศษ) อนุญาตให้แก้ไขภายหลังพร้อมตรวจสอบความซ้ำซ้อน
*   **Chapter Slug:** ใช้ `chapter_number` โดยตรง

---

## 3. บทบาทผู้ใช้และสิทธิ์ (User Roles & Permissions)

ควบคุมโดย Supabase Row-Level Security (RLS).

| บทบาท         | ความสามารถหลัก                                                                                                                                                                                                                                                                                       | แถบเครื่องมือ (Toolbar) เพิ่มเติม                                                                                                                              |
| :------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **สมาชิก (Member)** | อ่านนิยาย, บุ๊คมาร์คตอน, แก้ไขโปรไฟล์ส่วนตัว                                                                                                                                                                                                                                                         | **แถบเครื่องมือสำหรับอ่าน:** สารบัญ, ปรับแต่งการแสดงผล, บุ๊คมาร์ค, สลับธีมเว็บ, เปิด/ปิดโหมดอ่านต่อเนื่อง, นำทางตอน                                           |
| **นักแปล (Translator)** | สิทธิ์ทั้งหมดของสมาชิก, เปิด/ปิด "โหมดนักแปล" สำหรับนิยายที่มีสิทธิ์, เข้าถึงโหมดแปล, ใช้งานบรรทัดมาร์ค, สร้าง/จัดการนิยายและตอนของตนเอง (ผ่าน Modal), เข้าถึงแดชบอร์ดนักแปลและหน้าจัดการบรรทัดมาร์ค                                                                                                  | **แถบเครื่องมือพิเศษในโหมดแปล:** (เหมือน Member) เพิ่มเติม: คัดลอกมาร์คทั้งหมด (สำหรับตอนปัจจุบัน)                                                                |
| **ผู้ดูแลระบบ (Admin)** | สิทธิ์ทั้งหมดของนักแปล, เข้าถึงแดชบอร์ดผู้ดูแลระบบ, จัดการผู้ใช้, ดูข้อมูลมาร์คทั้งหมด, จัดการเว็บไซต์, จัดการหมวดหมู่นิยาย, จัดการประกาศ, จัดการเวอร์ชัน                                                                                                                                           | (เหมือน Translator)                                                                                                                                           |

---

## 4. การเข้าสู่ระบบ / ลงทะเบียน / ลืมรหัสผ่าน

*   **ความสามารถ:** ลงทะเบียน, เข้าสู่ระบบ, ลืมรหัสผ่าน
*   **การแสดงผล:** Modal เป็นหลัก (เมื่อเรียกจากภายในเว็บ), มีหน้าเว็บเฉพาะ (`/login`, `/register`, `/forgot-password`)
*   **การพัฒนา:** Supabase Auth, Felte + Zod, Skeleton UI
*   **การแจ้งเตือน:** Toast notification (เช่น "เข้าสู่ระบบสำเร็จ")

---

## 5. โครงสร้างแถบนำทาง (Navbar Structure)

แสดงเมนูตามบทบาท (Dynamic Menu), Responsive.

*   **Guest:** โลโก้, ปุ่มสลับธีม, ปุ่ม "เข้าสู่ระบบ" (เปิด Login Modal)
*   **Member:** โลโก้, "หน้าแรก", "บุ๊คมาร์ค", ปุ่มสลับธีม, โปรไฟล์ (Dropdown: ชื่อ, สิทธิ์, ลิงก์ "หน้าโปรไฟล์", ออกจากระบบ)
*   **Translator:** เหมือน Member เพิ่ม "แดชบอร์ดนักแปล"
*   **Admin:** เหมือน Translator เพิ่ม "แดชบอร์ดผู้ดูแลระบบ"
*   **การพัฒนา:** SvelteKit, Skeleton UI, TailwindCSS

---

## 6. รายละเอียดหน้าเว็บไซต์, Modals, และการจัดการเนื้อหา

### 6.1 หน้าแรก (Home Page - `/`)
*   **ส่วนแสดงประกาศ:** แสดงประกาศที่ Active และตรงตามสิทธิ์ผู้ใช้ (แบนเนอร์, ปุ่มปิด)
*   **ส่วนเครื่องมือหลัก:**
    *   ช่องค้นหานิยาย
    *   ฟิลเตอร์หมวดหมู่ (Dropdown)
    *   ฟิลเตอร์สถานะนิยาย (Dropdown: ต่อเนื่อง, จบแล้ว)
    *   ปุ่มสร้างนิยาย (สำหรับนักแปล/Admin): เปิด Modal สร้างนิยาย
*   **การแสดงรายการนิยาย:** Grid Layout (ปก 3:4, ชื่อ, จำนวนตอน), Mobile 2 คอลัมน์
*   **ระบบแบ่งหน้า (Pagination)**
*   **การทำงานเริ่มต้น (สำหรับ Guest):** แสดง Login Modal อัตโนมัติเมื่อเข้าชมครั้งแรก

    #### 6.1.1 Modal สร้างนิยาย (Create Novel Modal)
    *   **UI:** ชื่อเรื่อง, คำโปรย, หมวดหมู่, รูปปก (Crop 3:4, <3MB), ภาษาต้นฉบับ, สิทธิ์การมองเห็น, การตั้งค่าเริ่มต้นสำหรับตอนใหม่ (สถานะ, สิทธิ์เข้าถึง)
    *   **ปุ่ม:** "เผยแพร่นิยาย", "บันทึกเป็นฉบับร่าง", "ยกเลิก"
    *   **แจ้งเตือน:** Toast เมื่อสำเร็จ

### 6.2 หน้าข้อมูลนิยายและสารบัญ (Novel Detail Page - `/novels/[novel_slug]`)
*   **ส่วนแสดงประกาศ:** แสดงประกาศที่ Active และตรงเป้าหมาย
*   **ส่วนข้อมูลนิยาย:** รูปปก, ชื่อเรื่อง, ผู้แต่ง, หมวดหมู่, คำโปรย, จำนวนตอน, สถานะ, ภาษาต้นฉบับ
*   **(สำหรับนักแปล/Admin ที่มีสิทธิ์):** ปุ่มสลับ "โหมดนักแปล" (Toggle Switch, สถานะบันทึกเฉพาะผู้ใช้และนิยาย)
*   **ปุ่มจัดการนิยาย (ผู้สร้าง/Admin):** "แก้ไขข้อมูลนิยาย" (เปิด Modal), "ลบนิยาย" (Modal ยืนยัน)
*   **ส่วนเพิ่มตอน (ผู้สร้าง/Admin):** ปุ่ม "เพิ่มตอนด้วย .txt" (เปิด Modal), "เพิ่มตอน" (เปิด Modal)
*   **ส่วนสารบัญ (Table of Contents):**
    *   Collapse/Accordion, ปรับจำนวนตอนต่อกลุ่ม (10-100, default 50)
    *   รายการตอน: ไอคอนบุ๊คมาร์ค, ชื่อตอน, สถานะการอ่าน
    *   (นักแปล/Admin): ไอคอนสถานะตอน, ปุ่มแก้ไข/ลบตอน, ปุ่มคัดลอกมาร์คทั้งหมด

    #### 6.2.1 Modal แก้ไขข้อมูลนิยาย (Edit Novel Modal)
    *   **UI:** แก้ไขชื่อเรื่อง, คำโปรย, หมวดหมู่, รูปปก, ภาษาต้นฉบับ, สถานะนิยาย, สิทธิ์การมองเห็น, ค่าเริ่มต้นสำหรับตอนใหม่
    *   **ปุ่ม:** "บันทึกการเปลี่ยนแปลง", "ยกเลิก", "ลบนิยาย"
    *   **แจ้งเตือน:** Toast, สร้าง novel_versions หากมีการเปลี่ยนแปลง

    #### 6.2.2 Modal เพิ่มตอนด้วย .txt (Batch Upload Modal)
    *   **ความสามารถ:** Drag & Drop, Max 500 ไฟล์, Sort ชื่อไฟล์, ใช้ชื่อไฟล์เป็นชื่อตอน, จัดการไฟล์ซ้ำ (Overwrite/Skip), Progress Bar
    *   **แจ้งเตือน:** Toast สรุปผล (เพิ่ม X, เขียนทับ Y, ข้าม Z)
    *   **อัตโนมัติ:** สร้าง `mark_lines` และ `chapter_versions`

    #### 6.2.3 Modal เพิ่ม/แก้ไขตอน (Create/Edit Chapter Modal)
    *   **UI:** ชื่อตอน, เนื้อหา (Rich Text Editor - TipTap, Sarabun font), สถานะตอน, สิทธิ์การเข้าถึง (ค่าเริ่มต้นจาก Novel settings แต่ปรับได้)
    *   **ปุ่ม (เพิ่มใหม่):** "เผยแพร่ตอน", "บันทึกเป็นฉบับร่าง"
    *   **ปุ่ม (แก้ไข):** "บันทึกการเปลี่ยนแปลง" (สร้าง `chapter_versions` หากเนื้อหาเปลี่ยน)
    *   **อัตโนมัติ (สร้างใหม่):** สร้าง `mark_lines` และ `chapter_versions`
    *   **แจ้งเตือน:** Toast

### 6.3 หน้าบุ๊คมาร์ค (Bookmarks Page - `/bookmarks`)
*   แสดงนิยายที่บุ๊คมาร์ค (เรียงตามวันที่บุ๊คมาร์คล่าสุด)
*   แต่ละนิยาย: ปก, ชื่อ, ตอนล่าสุดที่บุ๊คมาร์ค, ปุ่ม "ไปยังบุ๊คมาร์คล่าสุด"
*   ปุ่ม "จัดการบุ๊คมาร์ค" (ต่อเรื่อง): เปิด Modal (เรียง, รายการบุ๊คมาร์คพร้อม Checkbox, ลบที่เลือก, ล้างทั้งหมดของเรื่อง, บันทึก)
*   ปุ่ม "ลบบุ๊คมาร์คทั้งหมด (ทุกเรื่อง)" (Modal ยืนยัน)

### 6.4 แดชบอร์ดนักแปล (Translator Dashboard - `/translator/dashboard`)
*   แสดงรายการนิยายที่นักแปลจัดการ (การ์ด: ปก, ชื่อ, ความคืบหน้าการมาร์ค % + Progress Bar)
*   ปุ่ม "จัดการบรรทัดมาร์ค" (นำทางไปหน้าจัดการ)

    #### 6.4.1 หน้าจัดการบรรทัดมาร์ค (Mark Line Management Page - `/translator/manage-marks/[novel_slug]`)
    *   **ควบคุมหลัก:** ปุ่ม "เลือกตอนเพื่อคัดลอก/ดาวน์โหลด" (Toggle โหมดเลือก, Batch Actions Toolbar)
    *   **สารบัญตอน:** Collapse/Accordion (ปรับจำนวนตอนต่อกลุ่ม), Checkbox "เลือกทั้งหมดในกลุ่ม" (เมื่อโหมดเลือก)
    *   **รายการตอน:** เลขลำดับ, ชื่อ, จำนวนมาร์ค, สถานะมาร์ค, ปุ่ม "คัดลอกมาร์คตอนนี้", Checkbox เลือกตอน (เมื่อโหมดเลือก)
    *   **Batch Actions Toolbar:** "คัดลอกบรรทัดมาร์ค", "ดาวน์โหลดไฟล์บรรทัดมาร์ค" (Modal ตัวเลือก: รวม .txt / แยก .zip)

### 6.5 หน้าอ่านนิยายและโหมดแปล (Reading & Translator Mode UI - `/novels/[novel_slug]/chapter/[chapter_number]`)
*   **การแสดงผลเนื้อหา:**
    *   ชื่อตอน (กลางบน)
    *   เนื้อหานิยาย: ย่อหน้า (text-indent), PC (Constrained Width), Mobile (Edge-to-edge), No Horizontal Scroll
    *   ปุ่ม "Arrow Up" (กลับไปบนสุด): ขวาล่าง, กึ่งโปร่งแสง
    *   ควบคุมด้วยคีย์บอร์ด (PC): ลูกศรซ้าย/ขวา (ตอนก่อน/ถัดไป), Space Bar (เลื่อนลง)
*   **โหมดการอ่าน (Member/Translator - ไม่เปิด "โหมดนักแปล"):**
    *   **Top Reading Toolbar (แสดงเสมอ):**
        *   PC: สารบัญ, ปรับแต่งการแสดงผล (Aa), บุ๊คมาร์ค, สลับธีม, โหมดอ่านต่อเนื่อง (ไอคอน Infinity, มี animation เมื่อเปิด), นำทางตอน (< ตอนก่อนหน้า, ตอนต่อไป >)
        *   Mobile: สารบัญ, ปรับแต่ง (Aa), บุ๊คมาร์ค, สลับธีม, โหมดอ่านต่อเนื่อง
    *   **Mobile Bottom Navigation Toolbar (ปรากฏเมื่อแตะเนื้อหา, ซ่อนเมื่อเลื่อน/แตะอีก):** < ตอนก่อนหน้า, ตอนต่อไป >
    *   **เมื่อเลื่อนถึงท้ายบท:**
        *   โหมดอ่านต่อเนื่อง **ปิด**: ปุ่มใหญ่ "ตอนต่อไป: [ชื่อตอนถัดไป]" (รีเฟรชหน้า)
        *   โหมดอ่านต่อเนื่อง **เปิด**: โหลดตอนถัดไปอัตโนมัติ (Infinite Scroll), อัปเดตชื่อตอนที่แสดง
*   **โหมดนักแปล (Translator - เปิด "โหมดนักแปล" สำหรับนิยายนี้):**
    *   **Top Reading Toolbar (แสดงเสมอ):** เหมือนโหมดอ่านปกติ + ปุ่ม "คัดลอกมาร์คทั้งหมด" (ไอคอน CopyCheck)
    *   **การแสดงผลเนื้อหา:**
        *   แถบเลขบรรทัด (Line Number Gutter) ด้านซ้าย (สีตาม Theme, ตัวเลขเด่นน้อยกว่าเนื้อหา)
        *   เนื้อหาต้นฉบับ
        *   Checkbox สำหรับมาร์ค (ขวาสุดของแต่ละบรรทัด)
    *   **MarkLine Interaction:** คลิก Checkbox (มาร์ค/ยกเลิก), ดับเบิลคลิกบรรทัด (คัดลอกข้อความ + มาร์ค)
    *   **เมื่อเลื่อนถึงท้ายบทในโหมดนักแปล:**
        *   สรุปข้อมูลการมาร์ค: "มีมาร์คทั้งหมด: X บรรทัด", "บรรทัดที่มาร์คได้แก่: 1, 2, ... (5 แรก + 'ดูทั้งหมด' -> Modal)"
        *   ปุ่ม "ล้างมาร์คทั้งหมดของตอนนี้" (Modal ยืนยัน)
        *   ปุ่ม "คัดลอกมาร์คทั้งหมดของตอนนี้"

### 6.6 แดชบอร์ดผู้ดูแลระบบ (Admin Dashboard - `/admin/dashboard/*`)
*   **Layout:** Sidebar ซ้าย (ภาพรวม, จัดการผู้ใช้, หมวดหมู่, ประกาศ, เว็บไซต์, เวอร์ชัน), พื้นที่เนื้อหาหลัก
    #### 6.6.1 หน้าภาพรวม (Overview - `/admin/dashboard/overview`)
    *   แสดงข้อมูลภาพรวม: จำนวนนิยาย, จำนวนผู้ใช้
    #### 6.6.2 หน้าจัดการผู้ใช้ (User Management - `/admin/dashboard/users`)
    *   ค้นหาผู้ใช้ (real-time), แสดงจำนวน
    *   ตารางผู้ใช้: #, Avatar, Email, ชื่อ, สิทธิ์, วันที่สมัคร, วันที่สิทธิ์หมดอายุ, ปุ่ม "จัดการ" (เปิด Modal)
    *   Modal จัดการผู้ใช้: Avatar, Email (R/O), ชื่อ, สิทธิ์ (Dropdown), วันที่สมัคร (R/O), วันที่สิทธิ์หมดอายุ (Date Picker, Easy Action: +1/3/6 เดือน, ไม่มี), ระงับบัญชี (Toggle)
    #### 6.6.3 หน้าจัดการหมวดหมู่ (Category Management - `/admin/dashboard/categories`)
    *   ปุ่ม "เพิ่มหมวดหมู่ใหม่" (เปิด Modal: ชื่อ, Slug, คำอธิบาย)
    *   รายการหมวดหมู่ (Accordion): ชื่อ, จำนวนนิยาย, ปุ่มแก้ไขชื่อ, ปุ่มลบ (Modal ยืนยัน + ย้ายนิยาย), ปุ่มแสดง/ซ่อนนิยาย
    #### 6.6.4 หน้าจัดการประกาศ (Announcement Management - `/admin/dashboard/announcements`)
    *   ปุ่ม "สร้างประกาศใหม่" (เปิด Modal)
    *   ตารางประกาศ: หัวข้อ, สถานะ, หน้าที่แสดง, กลุ่มผู้รับ, วันที่เริ่ม/สิ้นสุด, ปุ่มดำเนินการ (แก้ไข, ลบ, สลับสถานะ)
    *   Modal สร้าง/แก้ไขประกาศ: หัวข้อ, เนื้อหา (Markdown), วันที่เริ่ม/สิ้นสุด, หน้าที่แสดง (Checkbox), กลุ่มผู้รับ (Checkbox), สถานะ "ใช้งาน" (Toggle)
    #### 6.6.5 หน้าจัดการเว็บไซต์ (Site Management - `/admin/dashboard/site-management`)
    *   **ส่วนทั่วไป:** ชื่อเว็บ, คำอธิบาย (SEO), โลโก้, Favicon (อัปโหลด, Preview)
    *   **ส่วนการลงทะเบียน/เข้าสู่ระบบ:** เปิด/ปิดการลงทะเบียน, เปิด/ปิด Google Login (Toggles)
    *   **ส่วนเนื้อหา:** จำนวนรายการต่อหน้าเริ่มต้น, การตั้งค่าเริ่มต้นสำหรับนิยายใหม่ (สถานะตอน, สิทธิ์เข้าถึงตอน)
    *   ปุ่ม "บันทึกการตั้งค่า"
    #### 6.6.6 หน้าจัดการเวอร์ชัน (Version Management - `/admin/dashboard/versions`)
    *   **Tab 1: เวอร์ชันเว็บไซต์ / Changelog:**
        *   รายการ Changelog (เวอร์ชัน, วันที่, สรุป), ปุ่ม "เพิ่ม Changelog ใหม่" (Modal: เวอร์ชัน, วันที่, สรุป Markdown, สถานะ), ปุ่มแก้ไข/ลบ
    *   **Tab 2: เวอร์ชันนิยายและตอน:**
        *   ค้นหานิยาย
        *   รายการนิยาย: ปุ่ม "ดูประวัติเวอร์ชันนิยาย", ปุ่ม "ดูประวัติเวอร์ชันตอน"
        *   ประวัติเวอร์ชันนิยาย: รายการ (เวอร์ชัน, วันที่, ผู้แก้ไข), ปุ่ม "ดูรายละเอียด", "กู้คืน"
        *   ประวัติเวอร์ชันตอน: เลือกตอน, รายการ (เวอร์ชัน, วันที่, ผู้แก้ไข), ปุ่ม "ดูเนื้อหา", "กู้คืน"

### 6.7 หน้าโปรไฟล์ (Profile Page - `/profile`)
*   **รูปโปรไฟล์ (Avatar):** แสดง, ปุ่ม "เปลี่ยนรูปโปรไฟล์" (File Picker, Crop 1:1)
*   **ชื่อที่แสดง (Display Name):** แสดง, Input แก้ไข, ปุ่ม "บันทึกชื่อ"
*   **สิทธิ์ผู้ใช้งาน (Role):** แสดง (Read-only), Badge สีตามสิทธิ์ (Member: เขียว, Translator: เหลือง/ทอง, Admin: แดง)
*   **อีเมล (Email):** แสดง (Read-only)
*   **เปลี่ยนรหัสผ่าน:** ปุ่ม "เปลี่ยนรหัสผ่าน" (เปิด Modal: รหัสผ่านปัจจุบัน, ใหม่, ยืนยันใหม่)
*   **ออกจากระบบ:** ปุ่ม "ออกจากระบบ" (Modal ยืนยัน)

---

## 7. Key User Experience Flows & Enhancements
*   **การล็อกอินผ่าน Modal**
*   **การนำทางที่ชัดเจน**
*   **ประสบการณ์การอ่านที่ปรับแต่งได้และลื่นไหล** (โหมดอ่านต่อเนื่อง, ไม่มี horizontal scroll)
*   **เครื่องมือช่วยแปลที่ใช้งานง่าย** (โหมดนักแปล, บรรทัดมาร์ค)
*   **การตอบสนองของระบบ:** Empty/Loading States, Error Handling, Toast notifications สำหรับยืนยันการกระทำ (มุมล่างขวา)
*   **การออกแบบที่สวยงามและตอบสนองทุกอุปกรณ์** (Responsive Design)
*   **ปุ่ม Arrow Up** สำหรับเลื่อนกลับบนสุด
*   **การสร้าง `mark_lines` อัตโนมัติ** เมื่อสร้างตอนใหม่ (Manual/Batch) สำหรับนักแปลเจ้าของนิยาย

---

## 8. Database Structure (Supabase - PostgreSQL)

ตารางหลัก (Key Tables):

*   `roles`: นิยามบทบาทผู้ใช้ (member, translator, admin)
*   `profiles`: ข้อมูลผู้ใช้ (id UUID → `auth.users`, `display_name`, `avatar_url`, `role_id`, `role_expiry_date`, `is_suspended`)
*   `categories`: หมวดหมู่นิยาย (`id`, `name`, `slug`, `description`)
*   `novels`: ข้อมูลนิยาย (รวม `owner_id`, `title`, `slug`, `synopsis`, `cover_url`, `category_id`, `status`, `visibility`, `original_language`, `default_chapter_status`, `default_chapter_access_level`, `created_by`, `updated_by`)
*   `chapters`: ข้อมูลตอนนิยาย (`id`, `novel_id`, `chapter_number`, `title`, `slug`, `content_original`, `status`, `access_level` JSONB, `created_by`, `word_count`, `read_by_users` JSONB)
*   `user_bookmarks`: บุ๊คมาร์คของผู้ใช้ (`id`, `user_id`, `chapter_id`, `novel_id`, `bookmarked_at`)
*   `mark_lines`: บรรทัดที่นักแปลมาร์คไว้ (`id`, `chapter_id`, `user_id` (translator), `line_number`, `original_text_snippet`, `marked_at`)
*   `announcements`: ประกาศจาก Admin (`id`, `title`, `content`, `start_date`, `end_date`, `target_roles` JSONB, `target_pages` JSONB, `is_active`)
*   `site_settings`: การตั้งค่าเว็บไซต์ (`key` TEXT PRIMARY KEY, `value` JSONB)
*   `site_changelogs`: ประวัติการเปลี่ยนแปลงเวอร์ชันเว็บไซต์ (`id`, `version_number`, `release_date`, `summary`, `is_published`)
*   `novel_versions`: ประวัติเวอร์ชันของข้อมูลเมตานิยาย (`id`, `novel_id`, `version_number`, `metadata_snapshot` JSONB, `created_by`, `notes`)
*   `chapter_versions`: ประวัติเวอร์ชันของเนื้อหาตอน (`id`, `chapter_id`, `version_number`, `content_snapshot` TEXT, `content_original_snapshot` TEXT, `created_by`, `notes`)

**การรักษาความปลอดภัย:** Row-Level Security (RLS) ถูกนำมาใช้อย่างเข้มงวดในทุกตารางที่สำคัญ

---

## 9. Supabase Storage Buckets

*   `novel-covers`: สำหรับรูปปกนิยาย
*   `chapter-text-files`: (Temporary) สำหรับไฟล์ .txt ที่อัปโหลดแบบ Batch, ลบหลังประมวลผล
*   `avatars`: สำหรับรูปโปรไฟล์ผู้ใช้
*   `site_assets`: สำหรับโลโก้เว็บไซต์, Favicon

---

## 10. สรุป Tech Stack (Tech Stack Summary)

| ประเภท        | เทคโนโลยี                                                                          |
| :------------- | :---------------------------------------------------------------------------------- |
| Framework      | SvelteKit                                                                           |
| Styling        | TailwindCSS                                                                         |
| UI Library     | Skeleton UI                                                                         |
| Form Handling  | Felte                                                                               |
| Validation     | Zod                                                                                 |
| Icon Library   | Lucide-Svelte                                                                       |
| Backend        | Supabase Platform                                                                   |
| Database       | PostgreSQL (ผ่าน Supabase)                                                          |
| Authentication | Supabase Auth                                                                       |
| Storage        | Supabase Storage                                                                    |
| Edge Functions | Supabase Edge Functions (สำหรับ Logic ฝั่ง Server ที่ซับซ้อน หากจำเป็น)               |
| ภาษา           | TypeScript                                                                          |

---

## 11. การจัดการข้อผิดพลาดเบื้องต้น (Basic Error Handling)

*   **Client-Side Validation:** ใช้ Zod + Felte สำหรับฟอร์ม, แสดงข้อความ error ชัดเจน
*   **Server-Side Validation:** ตรวจสอบข้อมูลอีกครั้งใน SvelteKit server functions/actions หรือ Supabase Edge Functions (ใช้ Zod)
*   **User-Facing Error Messages:** ใช้ Toast notification หรือข้อความใน UI ที่เป็นมิตร, หลีกเลี่ยง Technical details
*   **Code-Level Error Handling:** `try...catch` ใน SvelteKit load/actions และ Supabase Edge Functions
*   **Error Logging:** `console.log`/`console.error` (Development), Supabase built-in Logging (Production)

---

## 12. มาตรการความปลอดภัยเบื้องต้น (Basic Security Measures)

*   **Authentication (Supabase Auth):**
    *   จัดการ Session, JWT, Refresh Token
    *   เปิดใช้งาน Email Verification
    *   (พิจารณา) Multi-Factor Authentication (MFA) ในอนาคต
*   **Authorization (Row-Level Security - RLS):**
    *   **หัวใจสำคัญ:** ป้องกันการเข้าถึง/แก้ไข/ลบข้อมูลโดยไม่ได้รับอนุญาต
    *   กำหนด Policies เข้มงวดสำหรับ `novels`, `chapters`, และตารางสำคัญอื่นๆ
    *   ตัวอย่าง Policy `DELETE` บน `novels`: `(auth.uid() = owner_id) OR ((SELECT role FROM profiles WHERE id = auth.uid()) = 'admin')`
*   **Input Validation:**
    *   ใช้ Zod ทั้ง Client-Side และ Server-Side (ป้องกัน SQLi, XSS)
    *   Sanitize HTML output (TipTap ควรช่วยจัดการส่วนนี้)
*   **HTTPS:** ให้บริการผ่าน HTTPS โดยอัตโนมัติ (Supabase, Vercel)
*   **Environment Variables:**
    *   เก็บ Keys (Supabase URL, Anon Key, Service Role Key) ใน `.env.local` (ห้าม commit)
    *   ใช้ Service Role Key ด้วยความระมัดระวัง (เฉพาะ Server-side)
*   **Data Backups:**
    *   Supabase Automated Backups
    *   (พิจารณา) Manual Backups (เช่น `pg_dump`) เป็นระยะ
*   **Principle of Least Privilege:**
    *   ผู้ใช้แต่ละบทบาทมีสิทธิ์เท่าที่จำเป็น
*   **Software Updates:**
    *   อัปเดต SvelteKit, Supabase client libraries, และ dependencies อื่นๆ สม่ำเสมอ

มาตรการเหล่านี้เป็นจุดเริ่มต้นที่ดี โดย Supabase ช่วยลดภาระงานด้านความปลอดภัย การเน้น RLS และ Input Validation เป็นสิ่งสำคัญอย่างยิ่ง
